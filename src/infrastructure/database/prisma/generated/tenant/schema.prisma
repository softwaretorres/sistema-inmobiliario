// ============================================
// TENANT DATABASE SCHEMA
// Each tenant has their own database with this schema
// ============================================

generator client {
  provider = "prisma-client-js"
  output   = "./generated/tenant"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USERS & AUTHENTICATION
// ============================================

model User {
  id        String     @id @default(uuid())
  email     String     @unique
  password  String
  firstName String     @map("first_name")
  lastName  String     @map("last_name")
  phone     String?
  avatar    String?
  status    UserStatus @default(ACTIVE)

  // Role relation
  roleId String @map("role_id")
  role   Role   @relation(fields: [roleId], references: [id])

  // Security
  lastLoginAt    DateTime? @map("last_login_at")
  failedAttempts Int       @default(0) @map("failed_attempts")
  lockedUntil    DateTime? @map("locked_until")

  // Preferences
  language String @default("es")
  timezone String @default("America/Mexico_City")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  properties    Property[]     @relation("PropertyAgent")
  transactions  Transaction[]
  activityLogs  ActivityLog[]
  refreshTokens RefreshToken[]

  @@index([email])
  @@index([status])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

// ============================================
// ROLES & PERMISSIONS (RBAC)
// ============================================

model Role {
  id          String  @id @default(uuid())
  name        String  @unique
  displayName String  @map("display_name")
  description String?
  isSystem    Boolean @default(false) @map("is_system")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  permissions RolePermission[]
  users       User[]

  @@map("roles")
}

model Permission {
  id          String  @id @default(uuid())
  action      String // create, read, update, delete, manage
  subject     String // Property, Owner, Client, Transaction, User, Role, etc.
  conditions  Json? // Optional conditions for fine-grained access
  description String?

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  roles RolePermission[]

  @@unique([action, subject])
  @@map("permissions")
}

model RolePermission {
  roleId       String @map("role_id")
  permissionId String @map("permission_id")

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

// ============================================
// PROPERTIES
// ============================================

model Property {
  id            String         @id @default(uuid())
  code          String         @unique // Internal reference code
  title         String
  description   String?        @db.Text
  type          PropertyType
  status        PropertyStatus @default(AVAILABLE)
  operationType OperationType  @map("operation_type")

  // Pricing
  salePrice   Decimal? @map("sale_price") @db.Decimal(12, 2)
  rentPrice   Decimal? @map("rent_price") @db.Decimal(10, 2)
  currency    String   @default("MXN")
  pricePerSqm Decimal? @map("price_per_sqm") @db.Decimal(10, 2)

  // Location
  address      String
  neighborhood String?
  city         String
  state        String
  country      String   @default("MX")
  zipCode      String?  @map("zip_code")
  latitude     Decimal? @db.Decimal(10, 8)
  longitude    Decimal? @db.Decimal(11, 8)

  // Characteristics
  bedrooms      Int?
  bathrooms     Decimal? @db.Decimal(3, 1)
  halfBathrooms Int?     @map("half_bathrooms")
  parkingSpaces Int?     @map("parking_spaces")
  totalArea     Decimal? @map("total_area") @db.Decimal(10, 2)
  builtArea     Decimal? @map("built_area") @db.Decimal(10, 2)
  lotArea       Decimal? @map("lot_area") @db.Decimal(10, 2)
  yearBuilt     Int?     @map("year_built")
  floors        Int?

  // Amenities & Features (JSON for flexibility)
  amenities Json? // {pool: true, gym: true, ...}
  features  Json? // {airConditioning: true, heating: true, ...}

  // Virtual tour / Media
  virtualTourUrl String? @map("virtual_tour_url")
  videoUrl       String? @map("video_url")

  // Relations
  ownerId String @map("owner_id")
  owner   Owner  @relation(fields: [ownerId], references: [id])
  agentId String @map("agent_id")
  agent   User   @relation("PropertyAgent", fields: [agentId], references: [id])

  images       PropertyImage[]
  documents    PropertyDocument[]
  transactions Transaction[]
  visits       PropertyVisit[]

  // SEO & Marketing
  slug            String? @unique
  metaTitle       String? @map("meta_title")
  metaDescription String? @map("meta_description")

  // Publishing
  publishedAt   DateTime? @map("published_at")
  featuredUntil DateTime? @map("featured_until")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([status, operationType])
  @@index([city, state])
  @@index([type])
  @@index([ownerId])
  @@index([agentId])
  @@index([salePrice])
  @@index([rentPrice])
  @@map("properties")
}

model PropertyImage {
  id           String  @id @default(uuid())
  url          String
  thumbnailUrl String? @map("thumbnail_url")
  caption      String?
  altText      String? @map("alt_text")
  isPrimary    Boolean @default(false) @map("is_primary")
  order        Int     @default(0)

  propertyId String   @map("property_id")
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([propertyId])
  @@map("property_images")
}

model PropertyDocument {
  id   String @id @default(uuid())
  name String
  type String // deed, blueprint, certificate, etc.
  url  String
  size Int? // File size in bytes

  propertyId String   @map("property_id")
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  uploadedAt DateTime @default(now()) @map("uploaded_at")

  @@index([propertyId])
  @@map("property_documents")
}

model PropertyVisit {
  id         String   @id @default(uuid())
  propertyId String   @map("property_id")
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  clientId   String?  @map("client_id")
  client     Client?  @relation(fields: [clientId], references: [id])

  scheduledAt DateTime    @map("scheduled_at")
  status      VisitStatus @default(SCHEDULED)
  notes       String?     @db.Text
  feedback    String?     @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([propertyId])
  @@index([clientId])
  @@index([scheduledAt])
  @@map("property_visits")
}

// ============================================
// OWNERS
// ============================================

model Owner {
  id   String    @id @default(uuid())
  type OwnerType

  // Individual fields
  firstName String? @map("first_name")
  lastName  String? @map("last_name")

  // Company fields
  companyName String? @map("company_name")
  legalName   String? @map("legal_name")
  taxId       String? @map("tax_id") // RFC in Mexico

  // Contact
  email          String
  phone          String
  alternatePhone String? @map("alternate_phone")

  // Address
  address String?
  city    String?
  state   String?
  country String? @default("MX")
  zipCode String? @map("zip_code")

  // Banking info (encrypted)
  bankName    String? @map("bank_name")
  bankAccount String? @map("bank_account")
  clabe       String? // Mexican interbank CLABE

  // Documents (JSON array of encrypted document info)
  documents Json?

  // Notes
  notes String? @db.Text

  // Relations
  properties Property[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([email])
  @@index([type])
  @@index([taxId])
  @@map("owners")
}

// ============================================
// CLIENTS (Leads)
// ============================================

model Client {
  id             String  @id @default(uuid())
  firstName      String  @map("first_name")
  lastName       String  @map("last_name")
  email          String
  phone          String
  alternatePhone String? @map("alternate_phone")

  // Lead source
  source       String? // website, referral, portal, social, etc.
  sourceDetail String? @map("source_detail") // Specific portal, campaign, etc.

  // Status
  status ClientStatus @default(NEW)

  // Budget & Preferences
  budget      Decimal? @db.Decimal(12, 2)
  preferences Json? // {type, locations, bedrooms, features, etc.}

  // Address (optional)
  address String?
  city    String?
  state   String?

  // Notes & Follow-up
  notes        String?   @db.Text
  nextFollowUp DateTime? @map("next_follow_up")

  // Relations
  transactions Transaction[]
  interactions ClientInteraction[]
  visits       PropertyVisit[]

  // Assignment
  assignedToId String? @map("assigned_to_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([email])
  @@index([status])
  @@index([assignedToId])
  @@map("clients")
}

model ClientInteraction {
  id       String @id @default(uuid())
  clientId String @map("client_id")
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  type    InteractionType
  subject String?
  notes   String?         @db.Text
  outcome String?

  scheduledAt DateTime? @map("scheduled_at")
  completedAt DateTime? @map("completed_at")

  // Who made the interaction
  userId String? @map("user_id")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([clientId])
  @@index([type])
  @@map("client_interactions")
}

// ============================================
// TRANSACTIONS
// ============================================

model Transaction {
  id     String            @id @default(uuid())
  code   String            @unique // Transaction reference
  type   TransactionType
  status TransactionStatus @default(PENDING)

  // Related entities
  propertyId String   @map("property_id")
  property   Property @relation(fields: [propertyId], references: [id])
  clientId   String   @map("client_id")
  client     Client   @relation(fields: [clientId], references: [id])
  agentId    String   @map("agent_id")
  agent      User     @relation(fields: [agentId], references: [id])

  // Financial
  listPrice   Decimal @map("list_price") @db.Decimal(12, 2)
  agreedPrice Decimal @map("agreed_price") @db.Decimal(12, 2)
  currency    String  @default("MXN")

  // Commission
  commissionPct    Decimal? @map("commission_pct") @db.Decimal(5, 2)
  commissionAmount Decimal? @map("commission_amount") @db.Decimal(12, 2)

  // For rentals
  depositAmount  Decimal?  @map("deposit_amount") @db.Decimal(12, 2)
  monthlyRent    Decimal?  @map("monthly_rent") @db.Decimal(10, 2)
  leaseStartDate DateTime? @map("lease_start_date")
  leaseEndDate   DateTime? @map("lease_end_date")

  // Important dates
  reservationDate DateTime? @map("reservation_date")
  contractDate    DateTime? @map("contract_date")
  closingDate     DateTime? @map("closing_date")

  // Documents
  documents Json?

  // Notes
  notes String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([status])
  @@index([type])
  @@index([propertyId])
  @@index([clientId])
  @@index([agentId])
  @@map("transactions")
}

// ============================================
// ACTIVITY LOG (Audit Trail)
// ============================================

model ActivityLog {
  id     String  @id @default(uuid())
  userId String? @map("user_id")
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  action   String // CREATE, UPDATE, DELETE, LOGIN, LOGOUT, etc.
  entity   String // Property, Owner, Client, Transaction, etc.
  entityId String? @map("entity_id")

  oldValues Json? @map("old_values")
  newValues Json? @map("new_values")

  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([entity, entityId])
  @@index([action])
  @@index([createdAt])
  @@map("activity_logs")
}

// ============================================
// SETTINGS
// ============================================

model Setting {
  id    String  @id @default(uuid())
  key   String  @unique
  value Json
  group String? // general, notifications, integrations, etc.

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([group])
  @@map("settings")
}

// ============================================
// ENUMS
// ============================================

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING
}

enum PropertyType {
  HOUSE
  APARTMENT
  CONDO
  LAND
  COMMERCIAL
  OFFICE
  WAREHOUSE
  INDUSTRIAL
  MIXED_USE
  OTHER
}

enum PropertyStatus {
  DRAFT
  AVAILABLE
  RESERVED
  IN_NEGOTIATION
  SOLD
  RENTED
  INACTIVE
  ARCHIVED
}

enum OperationType {
  SALE
  RENT
  BOTH
}

enum OwnerType {
  INDIVIDUAL
  COMPANY
}

enum ClientStatus {
  NEW
  CONTACTED
  QUALIFIED
  SHOWING
  NEGOTIATING
  CLOSED_WON
  CLOSED_LOST
  INACTIVE
}

enum InteractionType {
  CALL
  EMAIL
  WHATSAPP
  VISIT
  MEETING
  NOTE
  FOLLOW_UP
}

enum TransactionType {
  SALE
  RENT
}

enum TransactionStatus {
  PENDING
  RESERVED
  IN_CONTRACT
  COMPLETED
  CANCELLED
}

enum VisitStatus {
  SCHEDULED
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}
